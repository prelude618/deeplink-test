<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nametag Deep Link Test</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; }
  label { display:block; margin-bottom:6px; font-weight:600; }
  input, a { font-size:16px; }
  input { width:100%; max-width:420px; padding:8px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
  .btn { padding:10px 14px; border-radius:6px; border:1px solid #ccc; text-decoration:none; }
  .btn.primary { background:#0b57d0; color:#fff; border-color:#0b57d0; }
</style>

<h2>Nametag Deep Link Test</h2>

<label for="token">Token</label>
<input id="token" type="text" placeholder="rvapdsypcajnbn" />

<div class="row">
  <a id="openApp" class="btn primary" href="#">Open in app â†’ request</a>
  <a id="getApp" class="btn" href="#">Get the app (internal test)</a>
</div>

<script>
  const PKG = "nametag.hello";
  const INTERNAL_TEST_WEB = "https://play.google.com/apps/internaltest/4700760087118708525";
  const TESTER_OPT_IN = `https://play.google.com/apps/testing/${PKG}`;

  const tokenEl = document.getElementById("token");
  const openBtn = document.getElementById("openApp");
  const getBtn  = document.getElementById("getApp");

  tokenEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") openBtn.click();
  });

  openBtn.onclick = (e) => {
    e.preventDefault();
    const t = (tokenEl.value || "").trim();
    if (!t) return;

    let leftPage = false;
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") leftPage = true;
    }, { once: true });

    window.location.href = `nametag://i/${encodeURIComponent(t)}`;

    setTimeout(() => {
      if (!leftPage) window.location.replace(INTERNAL_TEST_WEB);
    }, 700);
  };

  getBtn.onclick = (e) => {
    e.preventDefault();
    const t = (tokenEl.value || "").trim();
    if (!t) return;

    let leftPage = false;
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") leftPage = true;
    }, { once: true });

    const ref = encodeURIComponent(`utm_source=qr&t=${encodeURIComponent(t)}`);
    const playAppIntent =
      `intent://details?id=${PKG}` +
      `#Intent;scheme=market;package=com.android.vending;S.referrer=${ref};end`;

    window.location.href = playAppIntent;

    setTimeout(() => {
      if (!leftPage) window.location.replace(INTERNAL_TEST_WEB);
    }, 700);

    setTimeout(() => {
      if (!leftPage) window.location.replace(TESTER_OPT_IN);
    }, 1600);
  };
</script>

