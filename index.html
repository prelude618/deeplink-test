<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nametag Deep Link Test</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; }
  h2 { margin-bottom: 12px; }
  label { display:block; margin-bottom:6px; font-weight:600; }
  input, a { font-size:16px; }
  input { width:100%; max-width:420px; padding:8px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
  .btn { padding:10px 14px; border-radius:6px; border:1px solid #ccc; text-decoration:none; }
  .btn.primary { background:#0b57d0; color:#fff; border-color:#0b57d0; }
  .hint { color:#666; font-size:13px; margin-top:12px; line-height:1.4; }
</style>

<h2>Nametag Deep Link Test</h2>

<label for="token">Token</label>
<input id="token" type="text" placeholder="rvapdsypcajnbn" />

<div class="row">
  <a id="openApp" class="btn primary" href="#">Open in app → request</a>
  <a id="getApp"  class="btn"         href="#">Get the app (internal test)</a>
</div>

<p class="hint">
  • Test in <b>Chrome</b> on Android (some in-app browsers block intents).<br/>
  • After install → <b>Open</b>, your app should read the Install Referrer and go straight to the request screen.
</p>

<script>
  // Your identifiers:
  const PKG = "nametag.hello";
  const INTERNAL_TEST_WEB = "https://play.google.com/apps/internaltest/4700760087118708525";
  const TESTER_OPT_IN = `https://play.google.com/apps/testing/${PKG}`;

  const tokenEl = document.getElementById("token");
  const openBtn = document.getElementById("openApp");
  const getBtn  = document.getElementById("getApp");

  tokenEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") openBtn.click();
  });

  // Installed case: try custom scheme; fallback to internal-test web if app isn't present.
  openBtn.onclick = (e) => {
    e.preventDefault();
    const t = (tokenEl.value || "").trim();
    if (!t) return;

    let leftPage = false;
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") leftPage = true;
    }, { once: true });

    // 1) Open your app directly
    window.location.href = `nametag://i/${encodeURIComponent(t)}`;

    // 2) If it didn't switch, send to internal-test listing (no back stack)
    setTimeout(() => {
      if (!leftPage) window.location.replace(INTERNAL_TEST_WEB);
    }, 700);
  };

  // Not-installed case: open Play APP with referrer (token); fallback chain:
  getBtn.onclick = (e) => {
    e.preventDefault();
    const t = (tokenEl.value || "").trim();
    if (!t) return;

    let leftPage = false;
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") leftPage = true;
    }, { once: true });

    // Play Store APP intent with the token in referrer
    const ref = encodeURIComponent(`utm_source=qr&t=${encodeURIComponent(t)}`);
    const playAppIntent =
      `intent://details?id=${PKG}` +
      `#Intent;scheme=market;package=com.android.vending;S.referrer=${ref};end`;

    // 1) Try Play app
    window.location.href = playAppIntent;

    // 2) If blocked (webview), go to internal-test web
    setTimeout(() => {
      if (!leftPage) window.location.replace(INTERNAL_TEST_WEB);
    }, 700);

    // 3) If user isn't enrolled, take them to opt-in
    setTimeout(() => {
      if (!leftPage) window.location.replace(TESTER_OPT_IN);
    }, 1600);
  };
</script>
